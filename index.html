<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Anywhere | Premium</title>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Chess.com Exact Dark Theme Colors */
            --bg-color: #312e2b; 
            --surface-color: #262421; 
            --surface-border: #403d39;
            --text-main: #ffffff;
            --text-muted: #8b8987;
            --accent-color: #81b64c; /* The classic chess.com green */
            --accent-hover: #a3d160;
            --light-square: #ebecd0; 
            --highlight: rgba(255, 255, 51, 0.5); 
            --clock-bg: #1e1e1e;
        }
        
        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Container Visibility */
        .view-container { display: none; width: 100%; max-width: 450px; flex-direction: column; align-items: center; }
        .active-view { display: flex; }

        /* --- HOME SCREEN --- */
        header { margin-top: 30px; margin-bottom: 20px; text-align: center; width: 100%; }
        h1 { margin: 0; font-size: 2rem; font-weight: 700; color: var(--text-main); }
        
        .home-logo { font-size: 4rem; margin-bottom: 30px; color: var(--accent-color); }
        
        .main-menu-btn {
            background-color: var(--surface-color); color: var(--text-main); 
            border: 1px solid var(--surface-border); 
            padding: 20px; font-size: 1.2rem; border-radius: 8px; cursor: pointer; 
            font-family: inherit; font-weight: 600; width: 90%; margin-bottom: 12px;
            transition: 0.1s; display: flex; flex-direction: column; align-items: center; gap: 6px;
        }
        .main-menu-btn:hover { background-color: #2c2926; }
        .main-menu-btn:active { background-color: var(--surface-border); }
        .main-menu-btn span.subtext { font-size: 0.85rem; font-weight: 400; color: var(--text-muted); }

        /* --- SHARED UI --- */
        .nav-header { 
            display: flex; width: 100%; max-width: 450px; justify-content: flex-start; align-items: center; 
            padding: 15px 20px; background-color: #21201d; margin-bottom: 15px;
        }
        .back-icon { 
            cursor: pointer; font-size: 1.5rem; color: var(--text-muted); font-weight: bold;
            margin-right: 15px; display: flex; justify-content: center; align-items: center;
        }
        .back-icon:active { color: var(--text-main); }
        .header-title { display: flex; align-items: center; gap: 8px; font-size: 1.2rem; font-weight: 600; color: var(--text-main); }

        /* --- BOARD STYLES --- */
        .board-wrapper { 
            width: 100%; max-width: 450px; touch-action: none; user-select: none; margin-bottom: 0; 
        }
        .white-1e1d7 { background-color: var(--light-square) !important; color: #739552 !important; }
        .black-3c85d { background-color: #739552 !important; color: var(--light-square) !important; }
        .board-wrapper img { transition: transform 0.3s ease; } 
        .board-wrapper.spin-pieces img { transform: rotate(180deg); }
        .square-55d63 { position: relative; cursor: pointer; }
        .highlight-selected { background-color: var(--highlight) !important; }
        .last-move { background-color: rgba(255, 255, 51, 0.4) !important; } 
        .highlight-dot::after { content: ''; position: absolute; top: 50%; left: 50%; width: 28%; height: 28%; background-color: rgba(0, 0, 0, 0.2); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        .highlight-capture::after { content: ''; position: absolute; top: 50%; left: 50%; width: 85%; height: 85%; border: 6px solid rgba(0, 0, 0, 0.2); border-radius: 50%; transform: translate(-50%, -50%); box-sizing: border-box; pointer-events: none; }

        /* --- PLAY UI STYLES --- */
        .player-info { width: 95%; max-width: 400px; display: flex; flex-direction: column; margin: 10px 0; }
        .clock-container { display: flex; justify-content: space-between; align-items: center; }
        .clock { 
            background-color: var(--surface-color); padding: 5px 12px; border-radius: 4px; 
            font-size: 1.2rem; font-weight: 700; font-family: monospace; color: var(--text-muted); 
            border: 1px solid var(--surface-border);
        }
        .clock.active { background-color: #ffffff; color: #000000; border-color: #ffffff; }
        .clock.low-time { background-color: #cc3333; color: #ffffff; border-color: #cc3333;}
        .captures { min-height: 24px; display: flex; align-items: center; gap: 2px; font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;}
        .captures img { width: 16px; height: 16px; }
        .score-advantage { color: var(--text-main); font-weight: 600; margin-left: 6px; font-size: 0.85rem;}
        
        #status { font-weight: 600; font-size: 1rem; margin-bottom: 12px; color: var(--text-main); text-align: center; }
        
        .controls { display: flex; justify-content: space-between; width: 95%; max-width: 400px; margin-bottom: 10px; gap: 8px;}
        .controls .btn { flex: 1; font-size: 0.9rem; padding: 12px; border-radius: 6px; background: var(--surface-color); border: none; color: var(--text-main); font-weight: 600; font-family: inherit;}
        .controls .btn:active:not(:disabled) { background: var(--surface-border); }
        .controls .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .history-box { 
            width: 95%; max-width: 400px; background: var(--surface-color); border-radius: 6px; 
            padding: 10px; height: 80px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; 
            color: var(--text-muted); margin-bottom: 20px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 6px; 
        }
        .history-move { background: transparent; padding: 2px 4px; border-radius: 4px; cursor: pointer; }
        .history-move.active { background: var(--surface-border); color: var(--text-main); font-weight: bold; }

        .menu { display: flex; width: 95%; max-width: 400px; margin-bottom: 30px; justify-content: center; gap: 10px;}
        .btn-primary { 
            background-color: var(--accent-color); color: white; border: none; 
            padding: 14px; font-size: 1rem; border-radius: 6px; cursor: pointer; 
            font-family: inherit; font-weight: 600; width: 100%; transition: 0.1s;
        }
        .btn-primary:hover { background-color: var(--accent-hover); }

        /* --- EXPLORER UI STYLES --- */
        .explorer-stats-container { 
            width: 100%; max-width: 450px; background: var(--surface-color); 
            height: 40vh; min-height: 250px; overflow-y: auto; 
            display: flex; flex-direction: column; border-top: 1px solid var(--surface-border);
        }
        .explorer-stats-container::-webkit-scrollbar { width: 4px; }
        .explorer-stats-container::-webkit-scrollbar-track { background: transparent; }
        .explorer-stats-container::-webkit-scrollbar-thumb { background: var(--surface-border); border-radius: 4px; }

        .explorer-header-row {
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 15px; border-bottom: 1px solid var(--surface-border); 
            background: var(--surface-color); position: sticky; top: 0; z-index: 10;
        }
        .opening-name { color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
        
        /* Minimalist Eval Badge */
        .eval-badge {
            padding: 2px 6px; border-radius: 4px; font-family: inherit;
            font-weight: 600; font-size: 0.85rem; color: var(--text-muted);
            border: 1px solid var(--surface-border); background: transparent;
        }

        .explorer-move-row { 
            display: flex; align-items: center; padding: 10px 15px; 
            border-bottom: 1px solid #33312e; cursor: pointer; 
        }
        .explorer-move-row:active { background: #33312e; }
        .exp-san { width: 45px; font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
        .exp-total { width: 85px; text-align: right; color: var(--text-muted); font-size: 0.85rem; margin-right: 15px; }
        
        /* Flat Progress Bars */
        .exp-bars { 
            flex-grow: 1; display: flex; height: 18px; border-radius: 2px; overflow: hidden; 
            font-size: 0.7rem; font-weight: 600; text-align: center; line-height: 18px;
        }
        .exp-w { background: #ffffff; color: #000000; }
        .exp-d { background: #73716e; color: #ffffff; }
        .exp-b { background: #191816; color: #8b8987; } /* Dark grey with muted text for black */
        
        /* Flat Controls that blend into the background */
        .explorer-controls { 
            display: flex; width: 100%; max-width: 450px; justify-content: space-around; 
            background: var(--bg-color); padding: 15px 5px 25px 5px; 
            position: sticky; bottom: 0; z-index: 100;
        }
        .exp-ctrl-btn { 
            background: none; border: none; color: var(--text-muted); 
            display: flex; flex-direction: column; align-items: center; 
            font-family: inherit; font-size: 0.75rem; font-weight: 500; cursor: pointer; 
        }
        .exp-ctrl-btn:active { color: var(--text-main); }
        .exp-ctrl-btn i { font-size: 1.4rem; margin-bottom: 4px; font-style: normal; font-weight: bold;}

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; }
        .modal-content { background: var(--surface-color); padding: 25px; border-radius: 8px; text-align: center; max-width: 350px; width: 85%; border: 1px solid var(--surface-border);}
        .modal-title { font-size: 1.4rem; font-weight: 700; margin-top: 0; margin-bottom: 20px; color: var(--text-main); }
        .mode-select { margin-bottom: 12px; padding: 12px; width: 100%; background: var(--bg-color); color: white; border: 1px solid var(--surface-border); border-radius: 6px; font-family: inherit; font-size: 0.95rem; outline: none;}
        
        .time-options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px;}
        .time-btn { background: var(--bg-color); color: white; border: 1px solid var(--surface-border); padding: 12px; border-radius: 6px; font-size: 0.9rem; font-family: inherit; cursor: pointer; font-weight: 500; }
        .time-btn:active { background: var(--accent-color); border-color: var(--accent-color); }
        
        .settings-row { display: flex; justify-content: center; align-items: center; gap: 10px; font-size: 0.9rem; margin-bottom: 20px; color: var(--text-muted);}
        input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent-color); cursor: pointer;}

        .promo-pieces { display: flex; justify-content: space-around; margin-top: 20px; }
        .promo-piece { width: 60px; height: 60px; cursor: pointer; background: var(--bg-color); border-radius: 6px; display: flex; justify-content: center; align-items: center; }
        .promo-piece img { width: 50px; height: 50px; }
        
        .hidden { display: none !important; }

        /* ================= RESPONSIVE LAYOUT ================= */
        @media (min-width: 768px) {
            .view-container { max-width: 900px; } 
            
            #explorerView.active-view {
                display: grid;
                grid-template-columns: 450px 380px;
                grid-template-rows: auto 1fr auto;
                gap: 0 25px;
                justify-content: center;
                align-items: start;
                margin-top: 20px;
            }
            
            #explorerView .nav-header { display: none; } /* Hide mobile header on PC */
            #explorerView .board-wrapper { grid-column: 1; grid-row: 1 / span 3; margin: 0; width: 100%; max-width: 100%;}
            
            #explorerView .explorer-stats-container { 
                grid-column: 2; 
                grid-row: 1; 
                width: 100%; 
                height: 380px; /* Aligns with board height */
                border-radius: 8px;
                border-top: none;
                border: 1px solid var(--surface-border);
            }
            
            #explorerView .explorer-controls { 
                grid-column: 2; 
                grid-row: 2; 
                width: 100%;
                position: static; 
                margin-top: 15px;
                padding: 10px 0;
            }
        }
    </style>
</head>
<body>

    <div id="homeView" class="view-container active-view">
        <header><h1>Chess Anywhere</h1></header>
        <div class="home-logo">‚ôû</div>
        
        <button class="main-menu-btn" onclick="openPlayMode()">
            Play Game
            <span class="subtext">PvP or Play vs Computer</span>
        </button>
        
        <button class="main-menu-btn" onclick="openExplorerMode()">
            <span style="color:var(--text-main); font-weight: 600;">üß≠ Explorer</span>
            <span class="subtext">Master Database & Engine Analysis</span>
        </button>
    </div>

    <div id="playView" class="view-container">
        
        <div class="nav-header">
            <div class="back-icon" onclick="goHome()">‚Üê</div>
            <div class="header-title">Play Game</div>
        </div>

        <div class="player-info">
            <div class="clock-container">
                <div style="font-weight: 600; color: var(--text-main);" id="blackLabel">Black</div>
                <div id="blackClock" class="clock">00:00</div>
            </div>
            <div class="captures" id="blackCaptures"></div>
        </div>

        <div id="board" class="board-wrapper"></div>

        <div class="player-info">
            <div class="captures" id="whiteCaptures"></div>
            <div class="clock-container">
                <div style="font-weight: 600; color: var(--text-main);">White (You)</div>
                <div id="whiteClock" class="clock">00:00</div>
            </div>
        </div>
        
        <div id="status">White to move</div>

        <div class="controls">
            <button class="btn" id="undoBtn" onclick="undoMove()">Undo</button>
            <button class="btn" id="pauseBtn" onclick="togglePause()">Pause</button>
            <button class="btn" id="redoBtn" onclick="redoMove()">Redo</button>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="offerDraw()">Draw</button>
            <button class="btn" onclick="resign()" style="color: #ff6b6b;">Resign</button>
        </div>

        <div class="history-box" id="moveHistory"></div>
        
        <div class="menu">
            <button class="btn-primary" style="background-color: var(--surface-color); color:var(--text-main);" onclick="showSetup()">‚öô Setup</button>
            <button class="btn-primary" onclick="copyPGN()">Export PGN</button>
        </div>
    </div>

    <div id="explorerView" class="view-container">
        <div class="nav-header">
            <div class="back-icon" onclick="goHome()">‚Üê</div>
            <div class="header-title">Explorer</div>
        </div>

        <div class="board-wrapper" style="position: relative;">
            <div id="explorerBoard" style="width: 100%;"></div>
            <svg id="arrowOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;">
                <defs>
                    <marker id="arrowhead" markerWidth="3" markerHeight="3" refX="2" refY="1.5" orient="auto">
                        <polygon points="0 0, 3 1.5, 0 3" fill="rgba(247, 143, 33, 0.8)" />
                    </marker>
                </defs>
            </svg>
        </div>

        <div class="explorer-stats-container">
            <div class="explorer-header-row">
                <div class="opening-name" id="expOpeningName">Starting Position</div>
                <div class="eval-badge" id="expEvalBadge"><span id="expEvalText">0.00</span></div>
            </div>
            <div id="expMovesList" style="flex-grow: 1;">
                <div style="padding: 30px; text-align: center; color: var(--text-muted);">Loading database...</div>
            </div>
        </div>

        <div class="explorer-controls">
            <button class="exp-ctrl-btn" onclick="expFlipBoard()"><i>‚áÖ</i>Flip Board</button>
            <button class="exp-ctrl-btn" onclick="expRestart()"><i>‚Ü∫</i>Restart</button>
            <button class="exp-ctrl-btn" onclick="expUndo()"><i>‚ùÆ</i>Back</button>
            <button class="exp-ctrl-btn" onclick="expRedo()"><i>‚ùØ</i>Forward</button>
        </div>
    </div>

    <div id="setupModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="modal-title">Game Setup</h2>
            <select id="gameMode" class="mode-select">
                <option value="pvp">Pass & Play (2 Players)</option>
                <option value="ai">Play vs Computer (AI)</option>
            </select>
            <select id="aiDifficulty" class="mode-select hidden">
                <option value="1">AI Difficulty: Easy</option>
                <option value="2">AI Difficulty: Medium</option>
                <option value="3">AI Difficulty: Hard</option>
            </select>
            <div class="time-options">
                <button class="time-btn" onclick="startGame(60)">1 min</button>
                <button class="time-btn" onclick="startGame(180)">3 min</button>
                <button class="time-btn" onclick="startGame(300)">5 min</button>
                <button class="time-btn" onclick="startGame(600)">10 min</button>
                <button class="time-btn" onclick="customTimeSetup()">Custom</button>
                <button class="time-btn" onclick="startGame(0)">Unlimited</button>
            </div>
            <div class="settings-row" id="flipSettingRow">
                <input type="checkbox" id="spinPiecesCheck" checked>
                <label for="spinPiecesCheck">Spin pieces for opponent</label>
            </div>
            <button class="btn" style="background:var(--surface-border); border:none; width:100%; padding:12px; border-radius:6px; color:white; font-weight:bold; margin-bottom:8px;" onclick="$('#setupModal').addClass('hidden')">Cancel</button>
            <button id="resumeBtn" class="btn hidden" style="background:var(--accent-color); border:none; width:100%; padding:12px; border-radius:6px; color:white; font-weight:bold;" onclick="resumeGame()">Resume Game</button>
        </div>
    </div>

    <div id="pauseModal" class="modal-overlay hidden"><div class="modal-content"><h2 class="modal-title">Paused</h2><button class="btn-primary" onclick="togglePause()">Resume</button></div></div>
    <div id="promotionModal" class="modal-overlay hidden"><div class="modal-content"><h2 class="modal-title">Promote Pawn</h2><div class="promo-pieces" id="promoContainer"></div></div></div>
    <div id="gameOverModal" class="modal-overlay hidden"><div class="modal-content"><h2 class="modal-title" id="winnerText">White Wins!</h2><p id="winReason" style="margin-bottom: 25px; color: var(--text-muted);">by Checkmate</p><button class="btn-primary" onclick="showSetup()">Play Again</button></div></div>

    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        // --- GLOBAL VARIABLES ---
        var pieceBaseUrl = 'https://lichess1.org/assets/piece/cburnett/';
        var currentMode = 'home'; 
        
        function goHome() {
            $('.view-container').removeClass('active-view');
            $('#homeView').addClass('active-view');
            if (currentMode === 'play') { isPaused = true; updateClocks(); }
            if (engine) engine.postMessage('stop'); 
            clearArrow();
            currentMode = 'home';
        }

        function openPlayMode() {
            $('.view-container').removeClass('active-view');
            $('#playView').addClass('active-view');
            currentMode = 'play';
            if (!board) initPlayMode();
            board.resize();
            checkSave();
            if(!gameActive) showSetup();
        }

        function openExplorerMode() {
            $('.view-container').removeClass('active-view');
            $('#explorerView').addClass('active-view');
            currentMode = 'explorer';
            if (!expBoard) initExplorerMode();
            expBoard.resize();
            if (expGame) evaluateExplorerPosition(); 
        }

        // ================= PLAY MODE LOGIC =================
        var board = null, game = null, $status = $('#status'), selectedSquare = null;
        var timeLimit = 0, timeW = 0, timeB = 0, timerInterval = null, gameActive = false, isPaused = false;
        var redoStack = [], pendingMove = null, spinPieces = true, playMode = 'pvp';

        function initPlayMode() {
            game = new Chess();
            var config = { draggable: false, position: 'start', pieceTheme: pieceBaseUrl + '{piece}.svg' };
            board = Chessboard('board', config);
            $('#board').on('click', '.square-55d63', function() {
                if (currentMode !== 'play' || !gameActive || isPaused || (playMode === 'ai' && game.turn() === 'b')) return; 
                handleSquareClickPlayMode($(this).attr('data-square'));
            });
        }

        $('#gameMode').on('change', function() {
            if (this.value === 'ai') { $('#spinPiecesCheck').prop('checked', false); $('#flipSettingRow').addClass('hidden'); $('#aiDifficulty').removeClass('hidden'); } 
            else { $('#flipSettingRow').removeClass('hidden'); $('#aiDifficulty').addClass('hidden'); }
        });

        function saveGameLocally() {
            if(!gameActive) return;
            localStorage.setItem('chessSave', JSON.stringify({ 
                fen: game.fen(), pgn: game.pgn(), timeW: timeW, timeB: timeB, timeLimit: timeLimit, 
                spinPieces: spinPieces, mode: playMode, diff: $('#aiDifficulty').val() 
            }));
        }
        function clearSave() { localStorage.removeItem('chessSave'); }
        function checkSave() { localStorage.getItem('chessSave') ? $('#resumeBtn').removeClass('hidden') : $('#resumeBtn').addClass('hidden'); }

        function resumeGame() {
            var save = JSON.parse(localStorage.getItem('chessSave'));
            if(save) {
                game.load_pgn(save.pgn); timeLimit = save.timeLimit; timeW = save.timeW; timeB = save.timeB;
                spinPieces = save.spinPieces; playMode = save.mode; 
                $('#spinPiecesCheck').prop('checked', spinPieces); $('#gameMode').val(playMode);
                if (playMode === 'ai') { $('#flipSettingRow').addClass('hidden'); $('#aiDifficulty').removeClass('hidden'); } else { $('#flipSettingRow').removeClass('hidden'); $('#aiDifficulty').addClass('hidden'); }
                $('#aiDifficulty').val(save.diff); board.position(game.fen()); redoStack = []; gameActive = true; isPaused = false; $('#setupModal').addClass('hidden');
                updateClocks(); updateStatus(); updateCapturesAndHistory(); if(playMode === 'ai' && game.turn() === 'b') setTimeout(makeComputerMove, 500);
            }
        }

        function showSetup() { $('#gameOverModal').addClass('hidden'); checkSave(); $('#setupModal').removeClass('hidden'); }
        function customTimeSetup() { var mins = prompt("Enter custom time in minutes:", "15"); if (mins !== null) { var p = parseFloat(mins); if (!isNaN(p) && p > 0) startGame(Math.floor(p * 60)); } }

        function startGame(seconds) {
            timeLimit = seconds; timeW = seconds; timeB = seconds; playMode = $('#gameMode').val(); spinPieces = $('#spinPiecesCheck').is(':checked');
            $('#blackLabel').text(playMode === 'ai' ? 'Black (Computer)' : 'Black');
            game.reset(); board.start(); selectedSquare = null; removeHighlights(); redoStack = []; gameActive = true; isPaused = false;
            $('#setupModal').addClass('hidden'); updateClocks(); startTimer(); updateStatus(); updateCapturesAndHistory(); saveGameLocally();
        }

        function formatTime(sec) { if (sec <= 0) return "00:00"; var m = Math.floor(sec / 60), s = sec % 60; return (m < 10 ? "0" : "") + m + ":" + (s < 10 ? "0" : "") + s; }
        function updateClocks() {
            if (timeLimit === 0) { $('#whiteClock, #blackClock').text("‚àû"); return; }
            $('#whiteClock').text(formatTime(timeW)); $('#blackClock').text(formatTime(timeB)); $('#whiteClock, #blackClock').removeClass('active low-time');
            if (gameActive && !isPaused) { var ac = game.turn() === 'w' ? $('#whiteClock') : $('#blackClock'); var at = game.turn() === 'w' ? timeW : timeB; ac.addClass('active'); if (at < 30) ac.addClass('low-time'); }
        }

        function startTimer() {
            if (timeLimit === 0) return; if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(function() {
                if (!gameActive || isPaused || currentMode !== 'play') return;
                if (game.turn() === 'w') { timeW--; if (timeW <= 0) endGame("Black", "on time"); } else { timeB--; if (timeB <= 0) endGame("White", "on time"); } updateClocks();
            }, 1000);
        }

        function togglePause() { if (!gameActive) return; isPaused = !isPaused; isPaused ? $('#pauseModal').removeClass('hidden') : $('#pauseModal').addClass('hidden'); updateClocks(); }
        function resign() { if (!gameActive || isPaused) return; if (confirm("Resign?")) endGame(game.turn() === 'w' ? 'Black' : 'White', "by Resignation"); }
        function offerDraw() { if (!gameActive || isPaused) return; if (playMode === 'ai') alert("Computer declines."); else if (confirm("Draw?")) endGame("Draw", "by agreement"); }

        function endGame(winnerName, reason) {
            gameActive = false; clearInterval(timerInterval); updateClocks(); clearSave();
            $('#winnerText').text(winnerName === "Draw" ? "Draw!" : winnerName + " Wins!").css('color', winnerName === "Draw" ? '#aaa' : 'var(--accent-color)');
            $('#winReason').text(reason); $('#gameOverModal').removeClass('hidden');
        }

        function updateCapturesAndHistory() {
            var history = game.history({ verbose: true }), pgnArr = game.pgn().split(' '), hHtml = '';
            for(var i=0; i<pgnArr.length; i++) hHtml += pgnArr[i].includes('.') ? '<span style="color:#888;">'+pgnArr[i]+'</span>' : '<span class="history-move '+(i===pgnArr.length-1?'active':'')+'">'+pgnArr[i]+'</span>';
            $('#moveHistory').html(hHtml); document.getElementById('moveHistory').scrollTop = document.getElementById('moveHistory').scrollHeight;
            var vals = {p:1, n:3, b:3, r:5, q:9}, cW = {p:0,n:0,b:0,r:0,q:0}, cB = {p:0,n:0,b:0,r:0,q:0}, sW = 0, sB = 0;
            history.forEach(m => { if(m.captured) { if(m.color === 'w') { cW[m.captured]++; sW += vals[m.captured]; } else { cB[m.captured]++; sB += vals[m.captured]; } } });
            function bHtml(caps, cP) { var h=''; ['p','n','b','r','q'].forEach(p=>{for(var i=0;i<caps[p];i++)h+='<img src="'+pieceBaseUrl+cP+p.toUpperCase()+'.svg">'}); return h;}
            var wH = bHtml(cW, 'b'), bH = bHtml(cB, 'w'); if(sW > sB) wH += '<span class="score-advantage">+' + (sW - sB) + '</span>'; if(sB > sW) bH += '<span class="score-advantage">+' + (sB - sW) + '</span>';
            $('#whiteCaptures').html(wH); $('#blackCaptures').html(bH);
        }

        function evaluateBoard(g) { var t=0, v={'p':10,'n':30,'b':30,'r':50,'q':90,'k':900}; g.board().forEach(r=>{r.forEach(p=>{if(p)t+=p.color==='w'?v[p.type]:-v[p.type];});}); return t; }
        function minimax(g, d, a, b, isMax) {
            if (d===0 || g.game_over()) return evaluateBoard(g); var m = g.moves();
            if (isMax) { var mx=-99999; for(var i=0;i<m.length;i++){g.move(m[i]); mx=Math.max(mx,minimax(g,d-1,a,b,false)); g.undo(); a=Math.max(a,mx); if(b<=a)break;} return mx; } 
            else { var mn=99999; for(var i=0;i<m.length;i++){g.move(m[i]); mn=Math.min(mn,minimax(g,d-1,a,b,true)); g.undo(); b=Math.min(b,mn); if(b<=a)break;} return mn; }
        }

        function makeComputerMove() {
            if (!gameActive || game.turn() === 'w') return; $status.html('Computer thinking...').css('color', 'var(--text-muted)');
            setTimeout(function() {
                var m = game.moves(); if(m.length===0) return; var d = parseInt($('#aiDifficulty').val()), bM = m[Math.floor(Math.random()*m.length)];
                if (d>1) { var bV=99999, a=-99999, b=99999; m.sort(()=>Math.random()-0.5); for(var i=0;i<m.length;i++){ game.move(m[i]); var v=minimax(game,d-1,a,b,true); game.undo(); if(v<bV){bV=v;bM=m[i];} b=Math.min(b,v); } }
                executeMove(bM); $status.css('color', 'var(--text-main)');
            }, 100);
        }

        function executeMove(mObj) {
            var m = game.move(mObj);
            if (m) { redoStack = []; board.position(game.fen()); removeHighlights(); selectedSquare = null; updateStatus(); updateCapturesAndHistory(); saveGameLocally(); if (playMode === 'ai' && game.turn() === 'b' && gameActive) makeComputerMove(); return true; } return false;
        }

        function undoMove() { if (!gameActive || isPaused) return; var m = game.undo(); if (playMode === 'ai' && m && game.turn() === 'b') { redoStack.push(m); m = game.undo(); } if (m) { redoStack.push(m); board.position(game.fen()); removeHighlights(); selectedSquare = null; updateStatus(); updateCapturesAndHistory(); saveGameLocally(); } }
        function redoMove() { if (!gameActive || isPaused || redoStack.length === 0) return; executeMove(redoStack.pop()); if (playMode === 'ai' && redoStack.length > 0) executeMove(redoStack.pop()); }

        function triggerPromotionUI(s, t, c) { pendingMove={from:s,to:t}; var h=''; ['q','r','n','b'].forEach(p=>{h+='<div class="promo-piece" onclick="finalizePromotion(\''+p+'\')"><img src="'+pieceBaseUrl+c+p.toUpperCase()+'.svg"></div>';}); $('#promoContainer').html(h); $('#promotionModal').removeClass('hidden'); }
        window.finalizePromotion = function(p) { $('#promotionModal').addClass('hidden'); executeMove({from:pendingMove.from,to:pendingMove.to,promotion:p}); pendingMove=null; };

        function removeHighlights() { $('#board .square-55d63').removeClass('highlight-dot highlight-capture highlight-selected'); }
        function showMoves(sq) { game.moves({square:sq,verbose:true}).forEach(m=>{var $s=$('#board .square-'+m.to); if(m.captured)$s.addClass('highlight-capture'); else $s.addClass('highlight-dot');}); }

        function handleSquareClickPlayMode(square) {
            var piece = game.get(square);
            if (selectedSquare) { if (game.moves({verbose:true}).some(m=>m.from===selectedSquare&&m.to===square&&m.promotion)) { triggerPromotionUI(selectedSquare, square, game.turn()); return; } if (executeMove({ from: selectedSquare, to: square })) return; }
            if (selectedSquare === square) { selectedSquare = null; removeHighlights(); return; }
            removeHighlights(); if (piece && piece.color === game.turn()) { selectedSquare = square; $('#board .square-'+square).addClass('highlight-selected'); showMoves(square); } else { selectedSquare = null; }
        }

        function updateStatus() {
            if (!gameActive) return; var mC = game.turn() === 'b' ? 'Black' : 'White';
            $('#undoBtn').prop('disabled', game.history().length === 0); $('#redoBtn').prop('disabled', redoStack.length === 0);
            $('#board .square-55d63').removeClass('last-move'); var h=game.history({verbose:true}); if(h.length>0){ $('#board .square-'+h[h.length-1].from).addClass('last-move'); $('#board .square-'+h[h.length-1].to).addClass('last-move'); }
            if (spinPieces && playMode === 'pvp' && game.turn() === 'b') $('#board').addClass('spin-pieces'); else $('#board').removeClass('spin-pieces');
            if (game.in_checkmate()) { endGame(mC==='White'?'Black':'White', "by Checkmate"); $status.html('Checkmate!'); } 
            else if (game.in_draw()) { endGame("Draw", "by rules"); $status.html('Draw'); } 
            else { var s = mC+' to move'; if(game.in_check()) s+=' (Check!)'; if(playMode!=='ai'||game.turn()!=='b') { $status.html(s); updateClocks(); } }
        }
        function copyPGN() { navigator.clipboard.writeText(game.pgn()).then(()=>alert("Copied!")); }


        // ================= EXPLORER MODE LOGIC =================
        var expBoard = null, expGame = null, expSelectedSquare = null;
        var expRedoStack = [];
        var expIsFlipped = false;
        var engine = null;

        function clearArrow() { $('#arrowOverlay').find('line').remove(); }

        function drawArrow(fromSq, toSq) {
            clearArrow(); 
            var $from = $('#explorerBoard .square-' + fromSq);
            var $to = $('#explorerBoard .square-' + toSq);
            var $overlay = $('#arrowOverlay');
            if ($from.length === 0 || $to.length === 0) return;
            
            var fromPos = $from.position(); var toPos = $to.position(); var sqSize = $from.width();
            var x1 = fromPos.left + (sqSize / 2); var y1 = fromPos.top + (sqSize / 2);
            var x2 = toPos.left + (sqSize / 2); var y2 = toPos.top + (sqSize / 2);
            
            var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', x1); line.setAttribute('y1', y1); line.setAttribute('x2', x2); line.setAttribute('y2', y2);
            line.setAttribute('stroke', 'rgba(247, 143, 33, 0.8)'); // Solid flat orange
            line.setAttribute('stroke-width', sqSize * 0.15); 
            line.setAttribute('stroke-linecap', 'round');
            line.setAttribute('marker-end', 'url(#arrowhead)');
            $overlay.append(line);
        }

        fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js')
            .then(res => res.text())
            .then(text => {
                var blob = new Blob([text], {type: 'application/javascript'});
                engine = new Worker(URL.createObjectURL(blob));
                engine.onmessage = function(event) {
                    var line = event.data;
                    if (line == 'uciok') { engine.postMessage('isready'); } 
                    else if (line.indexOf('info depth') !== -1 && line.indexOf('score cp') !== -1) {
                        var match = line.match(/score cp (-?\d+)/);
                        if (match) {
                            var score = parseInt(match[1]) / 100.0;
                            if (expGame.turn() === 'b') score = -score; 
                            var sign = score > 0 ? "+" : "";
                            $('#expEvalText').text(sign + score.toFixed(2));
                        }
                    } else if (line.indexOf('info depth') !== -1 && line.indexOf('score mate') !== -1) {
                        var match = line.match(/score mate (-?\d+)/);
                        if (match) {
                            var mateIn = parseInt(match[1]);
                            if (expGame.turn() === 'b') mateIn = -mateIn;
                            var sign = mateIn > 0 ? "+M" : "-M";
                            $('#expEvalText').text(sign + Math.abs(mateIn));
                        }
                    }
                    if (line.indexOf(' pv ') !== -1) {
                        var pvMatch = line.match(/ pv ([a-h][1-8][a-h][1-8][qrbn]?)/);
                        if (pvMatch) {
                            var bestMove = pvMatch[1];
                            drawArrow(bestMove.substring(0, 2), bestMove.substring(2, 4));
                        }
                    }
                };
                engine.postMessage('uci');
            });

        function evaluateExplorerPosition() {
            if (!engine || currentMode !== 'explorer') return;
            var fen = expGame.fen();
            $('#expEvalText').text("...");
            engine.postMessage('stop'); 
            clearArrow();
            
            var cloudUrl = 'https://lichess.org/api/cloud-eval?fen=' + encodeURIComponent(fen);
            fetch(cloudUrl)
                .then(response => {
                    if (!response.ok) throw new Error("Not in cloud");
                    return response.json();
                })
                .then(data => {
                    if (data.pvs && data.pvs.length > 0) {
                        var pv = data.pvs[0];
                        if (pv.cp !== undefined) {
                            var score = pv.cp / 100.0;
                            if (expGame.turn() === 'b') score = -score; 
                            var sign = score > 0 ? "+" : "";
                            $('#expEvalText').text(sign + score.toFixed(2));
                        } else if (pv.mate !== undefined) {
                            var mateIn = pv.mate;
                            if (expGame.turn() === 'b') mateIn = -mateIn;
                            var sign = mateIn > 0 ? "+M" : "-M";
                            $('#expEvalText').text(sign + Math.abs(mateIn));
                        }
                        if (pv.moves) {
                            var bestMove = pv.moves.split(' ')[0];
                            drawArrow(bestMove.substring(0, 2), bestMove.substring(2, 4));
                        }
                    }
                })
                .catch(err => {
                    engine.postMessage('position fen ' + fen);
                    engine.postMessage('go depth 18'); 
                });
        }

        function initExplorerMode() {
            expGame = new Chess();
            var config = { draggable: false, position: 'start', pieceTheme: pieceBaseUrl + '{piece}.svg' };
            expBoard = Chessboard('explorerBoard', config);
            
            $('#explorerBoard').on('click', '.square-55d63', function() {
                if (currentMode !== 'explorer') return;
                handleSquareClickExpMode($(this).attr('data-square'));
            });
            fetchExplorerData(); 
            evaluateExplorerPosition();
        }

        function expRemoveHighlights() { $('#explorerBoard .square-55d63').removeClass('highlight-dot highlight-capture highlight-selected last-move'); }
        function expShowMoves(sq) { expGame.moves({square:sq,verbose:true}).forEach(m=>{var $s=$('#explorerBoard .square-'+m.to); if(m.captured)$s.addClass('highlight-capture'); else $s.addClass('highlight-dot');}); }

        function handleSquareClickExpMode(square) {
            var piece = expGame.get(square);
            if (expSelectedSquare) {
                var moveParams = { from: expSelectedSquare, to: square };
                if (expGame.moves({verbose:true}).some(m=>m.from===expSelectedSquare&&m.to===square&&m.promotion)) moveParams.promotion = 'q';
                var move = expGame.move(moveParams);
                if (move) { expRedoStack = []; updateExplorerAfterMove(); return; }
            }
            if (expSelectedSquare === square) { expSelectedSquare = null; expRemoveHighlights(); return; }
            expRemoveHighlights();
            if (piece && piece.color === expGame.turn()) { expSelectedSquare = square; $('#explorerBoard .square-'+square).addClass('highlight-selected'); expShowMoves(square); } 
            else { expSelectedSquare = null; }
        }

        function updateExplorerAfterMove() {
            expSelectedSquare = null; expBoard.position(expGame.fen()); expRemoveHighlights(); clearArrow();
            var history = expGame.history({verbose: true});
            if(history.length > 0) {
                var last = history[history.length - 1];
                $('#explorerBoard .square-' + last.from).addClass('last-move'); $('#explorerBoard .square-' + last.to).addClass('last-move');
            }
            fetchExplorerData(); evaluateExplorerPosition(); 
        }

        function fetchExplorerData() {
            var fen = expGame.fen();
            $('#expMovesList').html('<div style="padding: 30px; text-align: center; color: var(--text-muted);">Fetching stats...</div>');
            var url = 'https://explorer.lichess.ovh/master?fen=' + encodeURIComponent(fen);
            
            fetch(url).then(response => response.json()).then(data => renderExplorerData(data)).catch(err => {
                $('#expMovesList').html('<div style="padding: 30px; text-align: center; color: var(--text-muted);">Error loading data.</div>');
            });
        }

        function renderExplorerData(data) {
            if (data.opening && data.opening.name) { $('#expOpeningName').text(data.opening.name); } else { $('#expOpeningName').text("Unknown Opening / Positional Play"); }
            var html = ''; var turnNum = Math.floor(expGame.history().length / 2) + 1;
            var prefix = expGame.turn() === 'w' ? turnNum + ". " : turnNum + "... ";

            if (!data.moves || data.moves.length === 0) {
                html = '<div style="padding: 30px; text-align: center; color: var(--text-muted);">No games found in database.</div>';
            } else {
                data.moves.forEach(move => {
                    var total = move.white + move.draws + move.black;
                    if (total === 0) return;
                    var wPct = Math.round((move.white / total) * 100);
                    var dPct = Math.round((move.draws / total) * 100);
                    var bPct = 100 - wPct - dPct; 
                    var totalStr = total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

                    html += `
                        <div class="explorer-move-row" onclick="makeExplorerMoveFromList('${move.san}')">
                            <div class="exp-san">${prefix}${move.san}</div>
                            <div class="exp-total">${totalStr}</div>
                            <div class="exp-bars">
                                ${wPct > 0 ? `<div class="exp-w" style="width: ${wPct}%">${wPct}%</div>` : ''}
                                ${dPct > 0 ? `<div class="exp-d" style="width: ${dPct}%">${dPct}%</div>` : ''}
                                ${bPct > 0 ? `<div class="exp-b" style="width: ${bPct}%">${bPct}%</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            $('#expMovesList').html(html);
        }

        window.makeExplorerMoveFromList = function(san) { var move = expGame.move(san); if (move) { expRedoStack = []; updateExplorerAfterMove(); } };
        window.expFlipBoard = function() { clearArrow(); expIsFlipped = !expIsFlipped; expBoard.orientation(expIsFlipped ? 'black' : 'white'); evaluateExplorerPosition(); };
        window.expRestart = function() { clearArrow(); expGame.reset(); expRedoStack = []; updateExplorerAfterMove(); };
        window.expUndo = function() { var move = expGame.undo(); if (move) { expRedoStack.push(move); updateExplorerAfterMove(); } };
        window.expRedo = function() { if (expRedoStack.length > 0) { var move = expRedoStack.pop(); expGame.move(move); updateExplorerAfterMove(); } };

        $(window).resize(function() {
            if (board && currentMode === 'play') board.resize();
            if (expBoard && currentMode === 'explorer') { clearArrow(); expBoard.resize(); evaluateExplorerPosition(); }
        });

    </script>
</body>
</html>

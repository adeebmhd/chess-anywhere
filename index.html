<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Anywhere | Premium</title>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-gradient: radial-gradient(circle at top center, #2a2a36, #121214);
            --surface-color: rgba(30, 30, 35, 0.6);
            --surface-border: rgba(255, 255, 255, 0.08);
            --text-main: #f0f0f0;
            --text-muted: #a0a0ab;
            --accent-color: #739552; 
            --accent-hover: #82a85e;
            --light-square: #ebecd0; 
            --highlight: rgba(235, 226, 75, 0.7); 
            --clock-bg: rgba(15, 15, 18, 0.8);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        header { margin-top: 25px; margin-bottom: 20px; text-align: center; width: 100%; }
        h1 { 
            margin: 0; font-size: 2.2rem; font-weight: 700; letter-spacing: -0.5px;
            background: linear-gradient(to right, #ffffff, var(--accent-color));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 10px 30px rgba(115, 149, 82, 0.2);
        }

        .view-container { display: none; width: 100%; max-width: 450px; flex-direction: column; align-items: center; animation: fadeIn 0.4s ease; }
        .active-view { display: flex; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .home-logo { font-size: 4.5rem; margin-bottom: 30px; filter: drop-shadow(0 0 15px rgba(115, 149, 82, 0.4)); }
        .main-menu-btn {
            background: var(--surface-color); color: var(--text-main); 
            border: 1px solid var(--surface-border); backdrop-filter: blur(10px);
            padding: 22px; font-size: 1.3rem; border-radius: 16px; cursor: pointer; 
            font-family: 'Poppins', sans-serif; font-weight: 600; width: 85%; margin-bottom: 15px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .main-menu-btn:hover { 
            transform: translateY(-4px); 
            border-color: var(--accent-color);
            box-shadow: 0 12px 25px rgba(115, 149, 82, 0.2);
        }
        .main-menu-btn:active { transform: translateY(0); }
        .main-menu-btn span.subtext { font-size: 0.85rem; font-weight: 400; color: var(--text-muted); }

        .nav-header { display: flex; width: 95%; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .back-icon { 
            cursor: pointer; font-size: 1.2rem; background: var(--surface-color); 
            border: 1px solid var(--surface-border); width: 42px; height: 42px; 
            border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            transition: 0.2s; backdrop-filter: blur(5px);
        }
        .back-icon:hover { background: #333; transform: scale(1.05); }
        .header-title { display: flex; align-items: center; gap: 10px; font-size: 1.2rem; font-weight: 600; letter-spacing: 0.5px;}

        .board-wrapper { 
            width: 95%; max-width: 400px; border-radius: 6px; overflow: hidden;
            box-shadow: 0 15px 35px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05); 
            touch-action: none; user-select: none; margin-bottom: 12px; 
        }
        .white-1e1d7 { background-color: var(--light-square) !important; color: var(--accent-color) !important; }
        .black-3c85d { background-color: var(--accent-color) !important; color: var(--light-square) !important; }
        .board-wrapper img { transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); } 
        .board-wrapper.spin-pieces img { transform: rotate(180deg); }
        .square-55d63 { position: relative; cursor: pointer; }
        .highlight-selected { background-color: var(--highlight) !important; }
        .last-move { background-color: rgba(235, 226, 75, 0.4) !important; } 
        .highlight-dot::after { content: ''; position: absolute; top: 50%; left: 50%; width: 25%; height: 25%; background-color: rgba(0, 0, 0, 0.3); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        .highlight-capture::after { content: ''; position: absolute; top: 50%; left: 50%; width: 85%; height: 85%; border: 6px solid rgba(0, 0, 0, 0.3); border-radius: 50%; transform: translate(-50%, -50%); box-sizing: border-box; pointer-events: none; }

        .player-info { width: 95%; max-width: 400px; display: flex; flex-direction: column; margin-bottom: 10px; }
        .clock-container { display: flex; justify-content: space-between; align-items: center; }
        .clock { 
            background-color: var(--clock-bg); padding: 6px 14px; border-radius: 8px; 
            font-size: 1.3rem; font-weight: 700; font-family: 'Courier New', Courier, monospace; 
            color: #777; transition: 0.3s; border: 1px solid rgba(0,0,0,0.5);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        .clock.active { background-color: #fff; color: #111; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .clock.low-time { background-color: #d93838; color: #ffffff; box-shadow: 0 0 10px rgba(217,56,56,0.4); }
        .captures { min-height: 24px; display: flex; align-items: center; gap: 2px; font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;}
        .captures img { width: 18px; height: 18px; opacity: 0.8; }
        .score-advantage { color: var(--accent-color); font-weight: 600; margin-left: 6px; }
        
        #status { font-weight: 500; font-size: 1.05rem; margin-bottom: 12px; color: var(--text-main); text-align: center; background: var(--surface-color); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--surface-border); display: inline-block;}
        
        .controls { display: flex; justify-content: space-between; width: 95%; max-width: 400px; margin-bottom: 10px; gap: 10px; flex-wrap: wrap;}
        .controls .btn { flex: 1; font-size: 0.85rem; padding: 10px; min-width: 20%; background: var(--surface-color); border: 1px solid var(--surface-border); color: var(--text-main);}
        .controls .btn:hover:not(:disabled) { background: #333; transform: translateY(-2px); }
        .controls .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .history-box { 
            width: 95%; max-width: 400px; background: rgba(15,15,18,0.5); border: 1px solid var(--surface-border);
            border-radius: 8px; padding: 12px; box-sizing: border-box; height: 75px; overflow-y: auto; 
            font-family: 'Courier New', Courier, monospace; font-size: 0.95rem; color: var(--text-muted); 
            margin-bottom: 20px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 8px; 
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.4);
        }
        .history-move { background: var(--surface-color); padding: 3px 8px; border-radius: 6px; }
        .history-move.active { background: var(--accent-color); color: white; font-weight: bold; box-shadow: 0 2px 5px rgba(115, 149, 82, 0.4);}

        .menu { display: flex; width: 95%; max-width: 400px; margin-bottom: 30px; justify-content: center; gap: 12px;}
        .btn { 
            background: linear-gradient(135deg, var(--accent-color), #5c7a41); color: white; 
            border: none; padding: 12px 15px; font-size: 1rem; border-radius: 10px; 
            cursor: pointer; font-family: 'Poppins', sans-serif; font-weight: 600; width: 100%; 
            transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(115, 149, 82, 0.2);
        }
        .btn:hover { background: linear-gradient(135deg, var(--accent-hover), var(--accent-color)); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(115, 149, 82, 0.3);}
        .btn:active { transform: translateY(0); }

        /* --- EXPLORER UI STYLES --- */
        .explorer-stats-container { 
            width: 95%; max-width: 400px; background: var(--surface-color); border: 1px solid var(--surface-border);
            border-radius: 12px; box-sizing: border-box; backdrop-filter: blur(10px);
            height: 35vh; min-height: 220px; overflow-y: auto; margin-bottom: 15px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.2); display: flex; flex-direction: column;
        }
        .explorer-stats-container::-webkit-scrollbar { width: 6px; }
        .explorer-stats-container::-webkit-scrollbar-track { background: transparent; }
        .explorer-stats-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

        .explorer-header-row {
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); 
            background: rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 10;
        }
        .opening-name { color: var(--text-muted); font-size: 0.95rem; font-weight: 500; }
        
        .eval-badge {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            padding: 4px 10px; border-radius: 6px; font-family: 'Courier New', monospace;
            font-weight: bold; font-size: 0.8rem; color: var(--text-main);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.3s; white-space: nowrap;
        }
        .eval-positive { color: #82a85e; border-color: rgba(130, 168, 94, 0.4); background: rgba(130, 168, 94, 0.1); }
        .eval-negative { color: #ff6b6b; border-color: rgba(255, 107, 107, 0.4); background: rgba(255, 107, 107, 0.1); }

        .explorer-move-row { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.03); cursor: pointer; transition: 0.2s; }
        .explorer-move-row:hover { background: rgba(255,255,255,0.05); padding-left: 20px; }
        .exp-san { width: 50px; font-weight: 600; color: #fff; font-size: 1rem; }
        .exp-total { width: 85px; text-align: right; color: var(--text-muted); font-size: 0.85rem; margin-right: 15px; font-family: 'Courier New', monospace;}
        
        .exp-bars { flex-grow: 1; display: flex; height: 20px; border-radius: 4px; overflow: hidden; font-size: 0.75rem; font-weight: 600; text-align: center; line-height: 20px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);}
        .exp-w { background: #e0e0e0; color: #111; }
        .exp-d { background: #777; color: #fff; }
        .exp-b { background: #333; color: #fff; }
        
        .explorer-controls { 
            display: flex; width: 95%; max-width: 400px; justify-content: space-around; 
            background: rgba(20, 20, 24, 0.85); backdrop-filter: blur(15px); border: 1px solid var(--surface-border);
            padding: 12px 5px; border-radius: 12px; margin-bottom: 25px; box-sizing: border-box;
            position: sticky; bottom: 15px; z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); 
        }
        .exp-ctrl-btn { background: none; border: none; color: var(--text-muted); display: flex; flex-direction: column; align-items: center; font-family: 'Poppins', sans-serif; font-size: 0.75rem; font-weight: 500; cursor: pointer; transition: 0.2s;}
        .exp-ctrl-btn:hover { color: #fff; transform: translateY(-2px); }
        .exp-ctrl-btn i { font-size: 1.3rem; margin-bottom: 4px; font-style: normal; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; }
        .modal-content { background: #1e1e24; padding: 30px 25px; border-radius: 16px; text-align: center; max-width: 350px; width: 85%; box-shadow: 0 15px 40px rgba(0,0,0,0.5); border: 1px solid var(--surface-border);}
        .modal-title { font-size: 1.6rem; font-weight: 700; margin-top: 0; margin-bottom: 20px; color: var(--text-main); }
        .mode-select { margin-bottom: 12px; padding: 12px; width: 100%; background: rgba(0,0,0,0.2); color: white; border: 1px solid var(--surface-border); border-radius: 8px; font-family: 'Poppins'; font-size: 0.95rem; outline: none;}
        .mode-select:focus { border-color: var(--accent-color); }
        
        .time-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;}
        .time-btn { background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--surface-border); padding: 12px; border-radius: 8px; font-size: 0.9rem; font-family: 'Poppins'; cursor: pointer; font-weight: 500; transition: 0.2s;}
        .time-btn:hover { background: rgba(255,255,255,0.1); }
        .time-btn:active { background: var(--accent-color); border-color: var(--accent-color); }
        
        .settings-row { display: flex; justify-content: center; align-items: center; gap: 10px; font-size: 0.9rem; margin-bottom: 20px; color: var(--text-muted);}
        input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent-color); cursor: pointer;}

        .promo-pieces { display: flex; justify-content: space-around; margin-top: 20px; }
        .promo-piece { width: 65px; height: 65px; cursor: pointer; background: rgba(255,255,255,0.05); border: 1px solid var(--surface-border); border-radius: 10px; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .promo-piece img { width: 55px; height: 55px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4));}
        .promo-piece:hover { background: rgba(255,255,255,0.1); transform: translateY(-3px);}
        .promo-piece:active { background: var(--accent-color); }
        
        .hidden { display: none !important; }
        .ai-thinking { color: var(--highlight) !important; animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* ================= RESPONSIVE LAYOUT ================= */
        @media (min-width: 768px) {
            .view-container { max-width: 900px; } 
            
            #explorerView.active-view {
                display: grid;
                grid-template-columns: 420px 420px;
                grid-template-rows: auto 1fr auto;
                gap: 0 30px;
                justify-content: center;
                align-items: start;
            }
            
            #explorerView .nav-header { grid-column: 1 / span 2; width: 100%; margin-bottom: 25px;}
            #explorerView .board-wrapper { grid-column: 1; grid-row: 2 / span 2; margin: 0; width: 100%; max-width: 100%;}
            
            #explorerView .explorer-stats-container { 
                grid-column: 2; 
                grid-row: 2; 
                width: 100%; 
                height: 420px; 
                margin: 0;
            }
            
            #explorerView .explorer-controls { 
                grid-column: 2; 
                grid-row: 3; 
                width: 100%;
                position: static; 
                margin-top: 20px;
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>

    <div id="homeView" class="view-container active-view">
        <header><h1>Chess Anywhere</h1></header>
        <div class="home-logo">‚ôû</div>
        
        <button class="main-menu-btn" onclick="openPlayMode()">
            Play Game
            <span class="subtext">PvP or Play vs Computer</span>
        </button>
        
        <button class="main-menu-btn" onclick="openExplorerMode()">
            <span style="font-size: 1.25rem; color:var(--text-main); font-weight: 600;">üß≠ Explorer</span>
            <span class="subtext">Master Database & Hybrid Engine</span>
        </button>
    </div>

    <div id="playView" class="view-container">
        
        <div class="nav-header">
            <div class="back-icon" onclick="goHome()">‚Üê</div>
            <div class="header-title">Play Game</div>
            <div style="width: 42px;"></div>
        </div>

        <div class="player-info">
            <div class="clock-container">
                <div style="font-weight: 500; color: var(--text-muted);" id="blackLabel">Black</div>
                <div id="blackClock" class="clock">00:00</div>
            </div>
            <div class="captures" id="blackCaptures"></div>
        </div>

        <div id="board" class="board-wrapper"></div>

        <div class="player-info">
            <div class="captures" id="whiteCaptures"></div>
            <div class="clock-container">
                <div style="font-weight: 500; color: var(--text-muted);">White (You)</div>
                <div id="whiteClock" class="clock">00:00</div>
            </div>
        </div>
        
        <div id="status">White to move</div>

        <div class="controls">
            <button class="btn" id="undoBtn" onclick="undoMove()">‚ü≤ Undo</button>
            <button class="btn" id="pauseBtn" onclick="togglePause()">‚è∏ Pause</button>
            <button class="btn" id="redoBtn" onclick="redoMove()">‚ü≥ Redo</button>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="offerDraw()">¬Ω Draw</button>
            <button class="btn" onclick="resign()" style="color: #ff6b6b; border-color: rgba(255,107,107,0.3);">‚öê Resign</button>
        </div>

        <div class="history-box" id="moveHistory"></div>
        
        <div class="menu">
            <button class="btn" style="background: var(--surface-color); border: 1px solid var(--surface-border);" onclick="showSetup()">‚öô Setup Menu</button>
            <button class="btn" style="background: var(--surface-color); border: 1px solid var(--surface-border);" onclick="copyPGN()">‚éò Export PGN</button>
        </div>
    </div>

    <div id="explorerView" class="view-container">
        <div class="nav-header">
            <div class="back-icon" onclick="goHome()">‚Üê</div>
            <div class="header-title">üß≠ Explorer</div>
            <div style="width: 42px;"></div>
        </div>

        <div class="board-wrapper" style="position: relative;">
            <div id="explorerBoard" style="width: 100%;"></div>
            <svg id="arrowOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;">
                <defs>
                    <marker id="arrowhead" markerWidth="3" markerHeight="3" refX="2" refY="1.5" orient="auto">
                        <polygon points="0 0, 3 1.5, 0 3" fill="rgba(255, 170, 0, 0.75)" />
                    </marker>
                </defs>
            </svg>
        </div>

        <div class="explorer-stats-container">
            <div class="explorer-header-row">
                <div class="opening-name" id="expOpeningName">Starting Position</div>
                <div class="eval-badge" id="expEvalBadge">Eval: <span id="expEvalText">0.00 (Cloud)</span></div>
            </div>
            <div id="expMovesList" style="flex-grow: 1;">
                <div style="padding: 30px; text-align: center; color: var(--text-muted);">Loading database...</div>
            </div>
        </div>

        <div class="explorer-controls">
            <button class="exp-ctrl-btn" onclick="expFlipBoard()"><i>‚áÖ</i>Flip Board</button>
            <button class="exp-ctrl-btn" onclick="expRestart()"><i>‚Ü∫</i>Restart</button>
            <button class="exp-ctrl-btn" onclick="expUndo()"><i>‚ùÆ</i>Back</button>
            <button class="exp-ctrl-btn" onclick="expRedo()"><i>‚ùØ</i>Forward</button>
        </div>
    </div>

    <div id="setupModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="modal-title">Game Setup</h2>
            <select id="gameMode" class="mode-select">
                <option value="pvp">Pass & Play (2 Players)</option>
                <option value="ai">Play vs Computer (AI)</option>
            </select>
            <select id="aiDifficulty" class="mode-select hidden">
                <option value="1">AI Difficulty: Easy</option>
                <option value="2">AI Difficulty: Medium</option>
                <option value="3">AI Difficulty: Hard</option>
            </select>
            <div class="time-options">
                <button class="time-btn" onclick="startGame(60)">Bullet (1 min)</button>
                <button class="time-btn" onclick="startGame(180)">Blitz (3 min)</button>
                <button class="time-btn" onclick="startGame(300)">Blitz (5 min)</button>
                <button class="time-btn" onclick="startGame(600)">Rapid (10 min)</button>
                <button class="time-btn" onclick="customTimeSetup()">Custom</button>
                <button class="time-btn" onclick="startGame(0)">Unlimited</button>
            </div>
            <div class="settings-row" id="flipSettingRow">
                <input type="checkbox" id="spinPiecesCheck" checked>
                <label for="spinPiecesCheck">Spin pieces for opponent</label>
            </div>
            <button class="btn" style="background:rgba(255,255,255,0.1); margin-top:10px; margin-bottom:10px;" onclick="$('#setupModal').addClass('hidden')">Cancel</button>
            <button id="resumeBtn" class="btn hidden" onclick="resumeGame()">Resume Game</button>
        </div>
    </div>

    <div id="pauseModal" class="modal-overlay hidden"><div class="modal-content"><h2 class="modal-title">Paused</h2><button class="btn" onclick="togglePause()">Resume</button></div></div>
    <div id="promotionModal" class="modal-overlay hidden"><div class="modal-content"><h2 class="modal-title">Promote Pawn</h2><div class="promo-pieces" id="promoContainer"></div></div></div>
    <div id="gameOverModal" class="modal-overlay hidden"><div class="modal-content"><h2 class="modal-title" id="winnerText">White Wins!</h2><p id="winReason" style="margin-bottom: 25px; color: var(--text-muted);">by Checkmate</p><button class="btn" onclick="showSetup()">Play Again</button></div></div>

    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        // --- GLOBAL VARIABLES ---
        var pieceBaseUrl = 'https://lichess1.org/assets/piece/cburnett/';
        var currentMode = 'home'; 
        
        function goHome() {
            $('.view-container').removeClass('active-view');
            $('#homeView').addClass('active-view');
            if (currentMode === 'play') { isPaused = true; updateClocks(); }
            if (engine) engine.postMessage('stop'); 
            clearArrow();
            currentMode = 'home';
        }

        function openPlayMode() {
            $('.view-container').removeClass('active-view');
            $('#playView').addClass('active-view');
            currentMode = 'play';
            if (!board) initPlayMode();
            board.resize();
            checkSave();
            if(!gameActive) showSetup();
        }

        function openExplorerMode() {
            $('.view-container').removeClass('active-view');
            $('#explorerView').addClass('active-view');
            currentMode = 'explorer';
            if (!expBoard) initExplorerMode();
            expBoard.resize();
            if (expGame) evaluateExplorerPosition(); 
        }

        // ================= PLAY MODE LOGIC =================
        var board = null, game = null, $status = $('#status'), selectedSquare = null;
        var timeLimit = 0, timeW = 0, timeB = 0, timerInterval = null, gameActive = false, isPaused = false;
        var redoStack = [], pendingMove = null, spinPieces = true, playMode = 'pvp';

        function initPlayMode() {
            game = new Chess();
            var config = { draggable: false, position: 'start', pieceTheme: pieceBaseUrl + '{piece}.svg' };
            board = Chessboard('board', config);
            $('#board').on('click', '.square-55d63', function() {
                if (currentMode !== 'play' || !gameActive || isPaused || (playMode === 'ai' && game.turn() === 'b')) return; 
                handleSquareClickPlayMode($(this).attr('data-square'));
            });
        }

        $('#gameMode').on('change', function() {
            if (this.value === 'ai') { $('#spinPiecesCheck').prop('checked', false); $('#flipSettingRow').addClass('hidden'); $('#aiDifficulty').removeClass('hidden'); } 
            else { $('#flipSettingRow').removeClass('hidden'); $('#aiDifficulty').addClass('hidden'); }
        });

        function saveGameLocally() {
            if(!gameActive) return;
            localStorage.setItem('chessSave', JSON.stringify({ 
                fen: game.fen(), pgn: game.pgn(), timeW: timeW, timeB: timeB, timeLimit: timeLimit, 
                spinPieces: spinPieces, mode: playMode, diff: $('#aiDifficulty').val() 
            }));
        }
        function clearSave() { localStorage.removeItem('chessSave'); }
        function checkSave() { localStorage.getItem('chessSave') ? $('#resumeBtn').removeClass('hidden') : $('#resumeBtn').addClass('hidden'); }

        function resumeGame() {
            var save = JSON.parse(localStorage.getItem('chessSave'));
            if(save) {
                game.load_pgn(save.pgn); timeLimit = save.timeLimit; timeW = save.timeW; timeB = save.timeB;
                spinPieces = save.spinPieces; playMode = save.mode; 
                $('#spinPiecesCheck').prop('checked', spinPieces); $('#gameMode').val(playMode);
                if (playMode === 'ai') { $('#flipSettingRow').addClass('hidden'); $('#aiDifficulty').removeClass('hidden'); } else { $('#flipSettingRow').removeClass('hidden'); $('#aiDifficulty').addClass('hidden'); }
                $('#aiDifficulty').val(save.diff); board.position(game.fen()); redoStack = []; gameActive = true; isPaused = false; $('#setupModal').addClass('hidden');
                updateClocks(); updateStatus(); updateCapturesAndHistory(); if(playMode === 'ai' && game.turn() === 'b') setTimeout(makeComputerMove, 500);
            }
        }

        function showSetup() { $('#gameOverModal').addClass('hidden'); checkSave(); $('#setupModal').removeClass('hidden'); }
        function customTimeSetup() { var mins = prompt("Enter custom time in minutes:", "15"); if (mins !== null) { var p = parseFloat(mins); if (!isNaN(p) && p > 0) startGame(Math.floor(p * 60)); } }

        function startGame(seconds) {
            timeLimit = seconds; timeW = seconds; timeB = seconds; playMode = $('#gameMode').val(); spinPieces = $('#spinPiecesCheck').is(':checked');
            $('#blackLabel').text(playMode === 'ai' ? 'Black (Computer)' : 'Black');
            game.reset(); board.start(); selectedSquare = null; removeHighlights(); redoStack = []; gameActive = true; isPaused = false;
            $('#setupModal').addClass('hidden'); updateClocks(); startTimer(); updateStatus(); updateCapturesAndHistory(); saveGameLocally();
        }

        function formatTime(sec) { if (sec <= 0) return "00:00"; var m = Math.floor(sec / 60), s = sec % 60; return (m < 10 ? "0" : "") + m + ":" + (s < 10 ? "0" : "") + s; }
        function updateClocks() {
            if (timeLimit === 0) { $('#whiteClock, #blackClock').text("‚àû"); return; }
            $('#whiteClock').text(formatTime(timeW)); $('#blackClock').text(formatTime(timeB)); $('#whiteClock, #blackClock').removeClass('active low-time');
            if (gameActive && !isPaused) { var ac = game.turn() === 'w' ? $('#whiteClock') : $('#blackClock'); var at = game.turn() === 'w' ? timeW : timeB; ac.addClass('active'); if (at < 30) ac.addClass('low-time'); }
        }

        function startTimer() {
            if (timeLimit === 0) return; if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(function() {
                if (!gameActive || isPaused || currentMode !== 'play') return;
                if (game.turn() === 'w') { timeW--; if (timeW <= 0) endGame("Black", "on time"); } else { timeB--; if (timeB <= 0) endGame("White", "on time"); } updateClocks();
            }, 1000);
        }

        function togglePause() { if (!gameActive) return; isPaused = !isPaused; isPaused ? $('#pauseModal').removeClass('hidden') : $('#pauseModal').addClass('hidden'); updateClocks(); }
        function resign() { if (!gameActive || isPaused) return; if (confirm("Resign?")) endGame(game.turn() === 'w' ? 'Black' : 'White', "by Resignation"); }
        function offerDraw() { if (!gameActive || isPaused) return; if (playMode === 'ai') alert("Computer declines."); else if (confirm("Draw?")) endGame("Draw", "by agreement"); }

        function endGame(winnerName, reason) {
            gameActive = false; clearInterval(timerInterval); updateClocks(); clearSave();
            $('#winnerText').text(winnerName === "Draw" ? "Draw!" : winnerName + " Wins!").css('color', winnerName === "Draw" ? '#aaa' : 'var(--accent-color)');
            $('#winReason').text(reason); $('#gameOverModal').removeClass('hidden');
        }

        function updateCapturesAndHistory() {
            var history = game.history({ verbose: true }), pgnArr = game.pgn().split(' '), hHtml = '';
            for(var i=0; i<pgnArr.length; i++) hHtml += pgnArr[i].includes('.') ? '<span style="color:#888;">'+pgnArr[i]+'</span>' : '<span class="history-move '+(i===pgnArr.length-1?'active':'')+'">'+pgnArr[i]+'</span>';
            $('#moveHistory').html(hHtml); document.getElementById('moveHistory').scrollTop = document.getElementById('moveHistory').scrollHeight;
            var vals = {p:1, n:3, b:3, r:5, q:9}, cW = {p:0,n:0,b:0,r:0,q:0}, cB = {p:0,n:0,b:0,r:0,q:0}, sW = 0, sB = 0;
            history.forEach(m => { if(m.captured) { if(m.color === 'w') { cW[m.captured]++; sW += vals[m.captured]; } else { cB[m.captured]++; sB += vals[m.captured]; } } });
            function bHtml(caps, cP) { var h=''; ['p','n','b','r','q'].forEach(p=>{for(var i=0;i<caps[p];i++)h+='<img src="'+pieceBaseUrl+cP+p.toUpperCase()+'.svg">'}); return h;}
            var wH = bHtml(cW, 'b'), bH = bHtml(cB, 'w'); if(sW > sB) wH += '<span class="score-advantage">+' + (sW - sB) + '</span>'; if(sB > sW) bH += '<span class="score-advantage">+' + (sB - sW) + '</span>';
            $('#whiteCaptures').html(wH); $('#blackCaptures').html(bH);
        }

        function evaluateBoard(g) { var t=0, v={'p':10,'n':30,'b':30,'r':50,'q':90,'k':900}; g.board().forEach(r=>{r.forEach(p=>{if(p)t+=p.color==='w'?v[p.type]:-v[p.type];});}); return t; }
        function minimax(g, d, a, b, isMax) {
            if (d===0 || g.game_over()) return evaluateBoard(g); var m = g.moves();
            if (isMax) { var mx=-99999; for(var i=0;i<m.length;i++){g.move(m[i]); mx=Math.max(mx,minimax(g,d-1,a,b,false)); g.undo(); a=Math.max(a,mx); if(b<=a)break;} return mx; } 
            else { var mn=99999; for(var i=0;i<m.length;i++){g.move(m[i]); mn=Math.min(mn,minimax(g,d-1,a,b,true)); g.undo(); b=Math.min(b,mn); if(b<=a)break;} return mn; }
        }

        function makeComputerMove() {
            if (!gameActive || game.turn() === 'w') return; $status.html('Computer thinking...').addClass('ai-thinking');
            setTimeout(function() {
                var m = game.moves(); if(m.length===0) return; var d = parseInt($('#aiDifficulty').val()), bM = m[Math.floor(Math.random()*m.length)];
                if (d>1) { var bV=99999, a=-99999, b=99999; m.sort(()=>Math.random()-0.5); for(var i=0;i<m.length;i++){ game.move(m[i]); var v=minimax(game,d-1,a,b,true); game.undo(); if(v<bV){bV=v;bM=m[i];} b=Math.min(b,v); } }
                executeMove(bM); $status.removeClass('ai-thinking');
            }, 100);
        }

        function executeMove(mObj) {
            var m = game.move(mObj);
            if (m) { redoStack = []; board.position(game.fen()); removeHighlights(); selectedSquare = null; updateStatus(); updateCapturesAndHistory(); saveGameLocally(); if (playMode === 'ai' && game.turn() === 'b' && gameActive) makeComputerMove(); return true; } return false;
        }

        function undoMove() { if (!gameActive || isPaused) return; var m = game.undo(); if (playMode === 'ai' && m && game.turn() === 'b') { redoStack.push(m); m = game.undo(); } if (m) { redoStack.push(m); board.position(game.fen()); removeHighlights(); selectedSquare = null; updateStatus(); updateCapturesAndHistory(); saveGameLocally(); } }
        function redoMove() { if (!gameActive || isPaused || redoStack.length === 0) return; executeMove(redoStack.pop()); if (playMode === 'ai' && redoStack.length > 0) executeMove(redoStack.pop()); }

        function triggerPromotionUI(s, t, c) { pendingMove={from:s,to:t}; var h=''; ['q','r','n','b'].forEach(p=>{h+='<div class="promo-piece" onclick="finalizePromotion(\''+p+'\')"><img src="'+pieceBaseUrl+c+p.toUpperCase()+'.svg"></div>';}); $('#promoContainer').html(h); $('#promotionModal').removeClass('hidden'); }
        window.finalizePromotion = function(p) { $('#promotionModal').addClass('hidden'); executeMove({from:pendingMove.from,to:pendingMove.to,promotion:p}); pendingMove=null; };

        function removeHighlights() { $('#board .square-55d63').removeClass('highlight-dot highlight-capture highlight-selected'); }
        function showMoves(sq) { game.moves({square:sq,verbose:true}).forEach(m=>{var $s=$('#board .square-'+m.to); if(m.captured)$s.addClass('highlight-capture'); else $s.addClass('highlight-dot');}); }

        function handleSquareClickPlayMode(square) {
            var piece = game.get(square);
            if (selectedSquare) { if (game.moves({verbose:true}).some(m=>m.from===selectedSquare&&m.to===square&&m.promotion)) { triggerPromotionUI(selectedSquare, square, game.turn()); return; } if (executeMove({ from: selectedSquare, to: square })) return; }
            if (selectedSquare === square) { selectedSquare = null; removeHighlights(); return; }
            removeHighlights(); if (piece && piece.color === game.turn()) { selectedSquare = square; $('#board .square-'+square).addClass('highlight-selected'); showMoves(square); } else { selectedSquare = null; }
        }

        function updateStatus() {
            if (!gameActive) return; var mC = game.turn() === 'b' ? 'Black' : 'White';
            $('#undoBtn').prop('disabled', game.history().length === 0); $('#redoBtn').prop('disabled', redoStack.length === 0);
            $('#board .square-55d63').removeClass('last-move'); var h=game.history({verbose:true}); if(h.length>0){ $('#board .square-'+h[h.length-1].from).addClass('last-move'); $('#board .square-'+h[h.length-1].to).addClass('last-move'); }
            if (spinPieces && playMode === 'pvp' && game.turn() === 'b') $('#board').addClass('spin-pieces'); else $('#board').removeClass('spin-pieces');
            if (game.in_checkmate()) { endGame(mC==='White'?'Black':'White', "by Checkmate"); $status.html('Checkmate!'); } 
            else if (game.in_draw()) { endGame("Draw", "by rules"); $status.html('Draw'); } 
            else { var s = mC+' to move'; if(game.in_check()) s+=' (Check!)'; if(playMode!=='ai'||game.turn()!=='b') { $status.html(s); updateClocks(); } }
        }
        function copyPGN() { navigator.clipboard.writeText(game.pgn()).then(()=>alert("Copied!")); }


        // ================= EXPLORER MODE LOGIC (HYBRID ENGINE & ARROWS) =================
        var expBoard = null, expGame = null, expSelectedSquare = null;
        var expRedoStack = [];
        var expIsFlipped = false;
        var engine = null;

        // --- ARROW DRAWING LOGIC ---
        function clearArrow() {
            $('#arrowOverlay').find('line').remove();
        }

        function drawArrow(fromSq, toSq) {
            clearArrow(); // remove old arrow
            
            var $from = $('#explorerBoard .square-' + fromSq);
            var $to = $('#explorerBoard .square-' + toSq);
            var $overlay = $('#arrowOverlay');
            
            // If the squares aren't found (e.g. board flipped mid-calc), skip drawing
            if ($from.length === 0 || $to.length === 0) return;
            
            var fromPos = $from.position();
            var toPos = $to.position();
            var sqSize = $from.width();
            
            // Get Exact Pixel Center of the Start and End Squares
            var x1 = fromPos.left + (sqSize / 2);
            var y1 = fromPos.top + (sqSize / 2);
            var x2 = toPos.left + (sqSize / 2);
            var y2 = toPos.top + (sqSize / 2);
            
            // Create SVG line dynamically
            var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', x1);
            line.setAttribute('y1', y1);
            line.setAttribute('x2', x2);
            line.setAttribute('y2', y2);
            line.setAttribute('stroke', 'rgba(255, 170, 0, 0.75)'); // Glowing orange
            line.setAttribute('stroke-width', sqSize * 0.15); // Scales thickness with screen size
            line.setAttribute('stroke-linecap', 'round');
            line.setAttribute('marker-end', 'url(#arrowhead)');
            
            $overlay.append(line);
        }

        // --- ENGINE LOGIC ---
        fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js')
            .then(res => res.text())
            .then(text => {
                var blob = new Blob([text], {type: 'application/javascript'});
                engine = new Worker(URL.createObjectURL(blob));
                
                engine.onmessage = function(event) {
                    var line = event.data;
                    if (line == 'uciok') {
                        engine.postMessage('isready');
                    } 
                    
                    // Update Evaluation Numbers
                    else if (line.indexOf('info depth') !== -1 && line.indexOf('score cp') !== -1) {
                        var match = line.match(/score cp (-?\d+)/);
                        if (match) {
                            var score = parseInt(match[1]) / 100.0;
                            if (expGame.turn() === 'b') score = -score; 
                            var sign = score > 0 ? "+" : "";
                            $('#expEvalText').text(sign + score.toFixed(2) + " (Local)");
                            
                            var $badge = $('#expEvalBadge');
                            $badge.removeClass('eval-positive eval-negative');
                            if (score > 0.5) $badge.addClass('eval-positive');
                            if (score < -0.5) $badge.addClass('eval-negative');
                        }
                    } else if (line.indexOf('info depth') !== -1 && line.indexOf('score mate') !== -1) {
                        var match = line.match(/score mate (-?\d+)/);
                        if (match) {
                            var mateIn = parseInt(match[1]);
                            if (expGame.turn() === 'b') mateIn = -mateIn;
                            var sign = mateIn > 0 ? "+M" : "-M";
                            $('#expEvalText').text(sign + Math.abs(mateIn) + " (Local)");
                            
                            var $badge = $('#expEvalBadge');
                            $badge.removeClass('eval-positive eval-negative');
                            mateIn > 0 ? $badge.addClass('eval-positive') : $badge.addClass('eval-negative');
                        }
                    }

                    // Extract the Best Move for the Arrow
                    if (line.indexOf(' pv ') !== -1) {
                        var pvMatch = line.match(/ pv ([a-h][1-8][a-h][1-8][qrbn]?)/);
                        if (pvMatch) {
                            var bestMove = pvMatch[1];
                            drawArrow(bestMove.substring(0, 2), bestMove.substring(2, 4));
                        }
                    }
                };
                engine.postMessage('uci');
            });

        function evaluateExplorerPosition() {
            if (!engine || currentMode !== 'explorer') return;
            var fen = expGame.fen();
            
            $('#expEvalText').text("...");
            $('#expEvalBadge').removeClass('eval-positive eval-negative');
            engine.postMessage('stop'); 
            clearArrow();
            
            // 1. Try Cloud API First
            var cloudUrl = 'https://lichess.org/api/cloud-eval?fen=' + encodeURIComponent(fen);
            fetch(cloudUrl)
                .then(response => {
                    if (!response.ok) throw new Error("Not in cloud");
                    return response.json();
                })
                .then(data => {
                    if (data.pvs && data.pvs.length > 0) {
                        var pv = data.pvs[0];
                        var score, sign;
                        
                        if (pv.cp !== undefined) {
                            score = pv.cp / 100.0;
                            if (expGame.turn() === 'b') score = -score; 
                            sign = score > 0 ? "+" : "";
                            $('#expEvalText').text(sign + score.toFixed(2) + " (Cloud)");
                            var $badge = $('#expEvalBadge');
                            if (score > 0.5) $badge.addClass('eval-positive');
                            if (score < -0.5) $badge.addClass('eval-negative');
                        } else if (pv.mate !== undefined) {
                            var mateIn = pv.mate;
                            if (expGame.turn() === 'b') mateIn = -mateIn;
                            sign = mateIn > 0 ? "+M" : "-M";
                            $('#expEvalText').text(sign + Math.abs(mateIn) + " (Cloud)");
                            var $badge = $('#expEvalBadge');
                            mateIn > 0 ? $badge.addClass('eval-positive') : $badge.addClass('eval-negative');
                        }

                        // Draw Cloud Arrow
                        if (pv.moves) {
                            var bestMove = pv.moves.split(' ')[0];
                            drawArrow(bestMove.substring(0, 2), bestMove.substring(2, 4));
                        }
                    }
                })
                .catch(err => {
                    // 2. Fallback to Local Engine
                    $('#expEvalText').text("Calc...");
                    engine.postMessage('position fen ' + fen);
                    engine.postMessage('go depth 18'); 
                });
        }

        function initExplorerMode() {
            expGame = new Chess();
            var config = { draggable: false, position: 'start', pieceTheme: pieceBaseUrl + '{piece}.svg' };
            expBoard = Chessboard('explorerBoard', config);
            
            $('#explorerBoard').on('click', '.square-55d63', function() {
                if (currentMode !== 'explorer') return;
                handleSquareClickExpMode($(this).attr('data-square'));
            });
            
            fetchExplorerData(); 
            evaluateExplorerPosition();
        }

        function expRemoveHighlights() { $('#explorerBoard .square-55d63').removeClass('highlight-dot highlight-capture highlight-selected last-move'); }
        function expShowMoves(sq) { expGame.moves({square:sq,verbose:true}).forEach(m=>{var $s=$('#explorerBoard .square-'+m.to); if(m.captured)$s.addClass('highlight-capture'); else $s.addClass('highlight-dot');}); }

        function handleSquareClickExpMode(square) {
            var piece = expGame.get(square);
            if (expSelectedSquare) {
                var moveParams = { from: expSelectedSquare, to: square };
                if (expGame.moves({verbose:true}).some(m=>m.from===expSelectedSquare&&m.to===square&&m.promotion)) moveParams.promotion = 'q';
                
                var move = expGame.move(moveParams);
                if (move) {
                    expRedoStack = [];
                    updateExplorerAfterMove();
                    return;
                }
            }
            
            if (expSelectedSquare === square) { expSelectedSquare = null; expRemoveHighlights(); return; }
            expRemoveHighlights();
            
            if (piece && piece.color === expGame.turn()) { 
                expSelectedSquare = square; 
                $('#explorerBoard .square-'+square).addClass('highlight-selected'); 
                expShowMoves(square); 
            } else { expSelectedSquare = null; }
        }

        function updateExplorerAfterMove() {
            expSelectedSquare = null;
            expBoard.position(expGame.fen());
            expRemoveHighlights();
            clearArrow();
            
            var history = expGame.history({verbose: true});
            if(history.length > 0) {
                var last = history[history.length - 1];
                $('#explorerBoard .square-' + last.from).addClass('last-move');
                $('#explorerBoard .square-' + last.to).addClass('last-move');
            }
            
            fetchExplorerData();
            evaluateExplorerPosition(); 
        }

        function fetchExplorerData() {
            var fen = expGame.fen();
            $('#expMovesList').html('<div style="padding: 30px; text-align: center; color: var(--text-muted);">Fetching stats...</div>');
            
            var url = 'https://explorer.lichess.ovh/master?fen=' + encodeURIComponent(fen);
            
            fetch(url)
                .then(response => response.json())
                .then(data => renderExplorerData(data))
                .catch(err => {
                    $('#expMovesList').html('<div style="padding: 30px; text-align: center; color: #ff6b6b;">Error loading data.</div>');
                });
        }

        function renderExplorerData(data) {
            if (data.opening && data.opening.name) {
                $('#expOpeningName').text(data.opening.name);
            } else {
                $('#expOpeningName').text("Unknown Opening / Positional Play");
            }

            var html = '';
            var turnNum = Math.floor(expGame.history().length / 2) + 1;
            var prefix = expGame.turn() === 'w' ? turnNum + ". " : turnNum + "... ";

            if (!data.moves || data.moves.length === 0) {
                html = '<div style="padding: 30px; text-align: center; color: var(--text-muted);">Unique position reached.<br><br><span style="color: var(--accent-color); font-weight: 600;">Engine analysis is active.</span></div>';
            } else {
                data.moves.forEach(move => {
                    var total = move.white + move.draws + move.black;
                    if (total === 0) return;
                    
                    var wPct = Math.round((move.white / total) * 100);
                    var dPct = Math.round((move.draws / total) * 100);
                    var bPct = 100 - wPct - dPct; 

                    var totalStr = total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

                    html += `
                        <div class="explorer-move-row" onclick="makeExplorerMoveFromList('${move.san}')">
                            <div class="exp-san">${prefix}${move.san}</div>
                            <div class="exp-total">${totalStr}</div>
                            <div class="exp-bars">
                                ${wPct > 0 ? `<div class="exp-w" style="width: ${wPct}%">${wPct}%</div>` : ''}
                                ${dPct > 0 ? `<div class="exp-d" style="width: ${dPct}%">${dPct}%</div>` : ''}
                                ${bPct > 0 ? `<div class="exp-b" style="width: ${bPct}%">${bPct}%</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            $('#expMovesList').html(html);
        }

        window.makeExplorerMoveFromList = function(san) {
            var move = expGame.move(san);
            if (move) {
                expRedoStack = [];
                updateExplorerAfterMove();
            }
        };

        window.expFlipBoard = function() {
            clearArrow();
            expIsFlipped = !expIsFlipped;
            expBoard.orientation(expIsFlipped ? 'black' : 'white');
            evaluateExplorerPosition(); // redraw arrow on flipped board
        };

        window.expRestart = function() {
            clearArrow();
            expGame.reset();
            expRedoStack = [];
            updateExplorerAfterMove();
        };

        window.expUndo = function() {
            var move = expGame.undo();
            if (move) {
                expRedoStack.push(move);
                updateExplorerAfterMove();
            }
        };

        window.expRedo = function() {
            if (expRedoStack.length > 0) {
                var move = expRedoStack.pop();
                expGame.move(move);
                updateExplorerAfterMove();
            }
        };

        $(window).resize(function() {
            if (board && currentMode === 'play') board.resize();
            if (expBoard && currentMode === 'explorer') {
                clearArrow();
                expBoard.resize();
            }
        });

    </script>
</body>
</html>
